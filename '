document.addEventListener("DOMContentLoaded", () => {
  const themeToggle = document.getElementById("theme-toggle");
  const body = document.body;

  function setTheme(theme) {
    if (theme === "dark") {
      body.classList.add("dark");
      localStorage.setItem("theme", "dark");
    } else {
      body.classList.remove("dark");
      localStorage.setItem("theme", "light");
    }
  }

  // Initialize Theme
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme) {
    setTheme(savedTheme);
  } else if (
    window.matchMedia &&
    window.matchMedia("(prefers-color-scheme: dark)").matches
  ) {
    setTheme("dark");
  } else {
    setTheme("light");
  }

  // Theme Toggle Listener
  if (themeToggle) {
    themeToggle.addEventListener("click", () => {
      if (body.classList.contains("dark")) {
        setTheme("light");
      } else {
        setTheme("dark");
      }
    });
  }

  // Navigation Logic
  const trackerNavButtons = document.querySelectorAll(
    ".tracker-nav-button:not(.section-button)",
  );

  const setActiveTrackerNavButton = (path) => {
    trackerNavButtons.forEach((button) => {
      const buttonPath = button.getAttribute("data-path");
      const normalizedPath = path.replace(/\/$/, "");

      if (
        buttonPath === normalizedPath ||
        (buttonPath === "/" && normalizedPath === "")
      ) {
        button.classList.add("active");
      } else {
        button.classList.remove("active");
      }
    });
  };

  // HTMX Listeners for Navigation Updates
  document.body.addEventListener("htmx:afterSwap", () => {
    setActiveTrackerNavButton(window.location.pathname);
  });

  document.body.addEventListener("htmx:historyCacheMiss", () => {
    setActiveTrackerNavButton(window.location.pathname);
  });

  // Initial check
  setActiveTrackerNavButton(window.location.pathname);
});

// --- Custom Dialog Functions (Must be global for inline 'onclick') ---

// Variables must be scoped globally if used outside DOMContentLoaded
const dialog = document.getElementById("action-dialog");
const backdrop = document.getElementById("backdrop");

function showCustomDialog() {
  if (!dialog || !backdrop) {
    console.error("Dialog or Backdrop element missing.");
    return;
  }
  backdrop.style.display = "block";
  backdrop.classList.add("blurred-content");

  dialog.show();
}

function hideCustomDialog() {
  if (!dialog || !backdrop) {
    console.error("Dialog or Backdrop element missing.");
    return;
  }
  backdrop.style.display = "none";
  backdrop.classList.remove("blurred-content");

  dialog.close();
  dialog.textContent = "";
}

// Backdrop Click Listener
if (backdrop) {
  backdrop.addEventListener("click", hideCustomDialog);
}
