{{ define "home-chart" }}
<section id="chart-section">
  <div>
    <form id="search-form">
      <input type="date" id="from" value="{{ .DateBefore }}" />
      <input type="date" id="to" value="{{ .DateNow }}" />
      <button type="button" id="chart-search">Search</button>
    </form>
  </div>
  <canvas id="chart"></canvas>
  <script>
    function updateChart() {
      const btn = document.getElementById("chart-search");
      if (!btn) return;

      const fromDate = document.getElementById("from");
      const toDate = document.getElementById("to");

      const canvas = document.getElementById("chart");

      fetch("/home/chart/search" + `?from=${fromDate.value}&to=${toDate.value}`)
        .then((r) => r.json())
        .then((apiData) => {
          if (!apiData || apiData.length === 0) {
            if (canvas.Chart) {
              canvas.Chart.destroy();
            }
            return;
          }

          const labels = apiData.map((item) => item.UtilityType);
          const amounts = apiData.map((item) => item.Amount);

          const ctx = canvas.getContext("2d");

          if (canvas.Chart) {
            canvas.Chart.destroy();
          }

          canvas.Chart = new Chart(ctx, {
            type: "pie",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Total Amount ($)",
                  data: amounts,
                  backgroundColor: [
                    "rgba(255, 99, 132, 0.6)",
                    "rgba(54, 162, 235, 0.6)",
                    "rgba(255, 206, 86, 0.6)",
                    "rgba(75, 192, 192, 0.6)",
                    "rgba(153, 102, 255, 0.6)",
                    "rgba(255, 159, 64, 0.6)",
                  ],
                  borderColor: [
                    "rgba(255, 99, 132, 1)",
                    "rgba(54, 162, 235, 1)",
                    "rgba(255, 206, 86, 1)",
                    "rgba(75, 192, 192, 1)",
                    "rgba(153, 102, 255, 1)",
                    "rgba(255, 159, 64, 1)",
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: "Amount ($)",
                  },
                },
                x: {
                  title: {
                    display: true,
                    text: "Utility Type",
                  },
                },
              },
              plugins: {
                legend: {
                  display: true,
                  position: "bottom",
                },
                title: {
                  display: true,
                  text: "Home Expenses by Utility Type",
                },
              },
            },
          });
        })
        .catch((error) => console.error("Error fetching data:", error));
    }

    document.body.addEventListener("htmx:afterOnLoad", (event) => {
      const newBtn = document.getElementById("chart-search");
      if (newBtn) {
        newBtn.addEventListener("click", updateChart);
      }
    });
  </script>
</section>
{{ end }}
